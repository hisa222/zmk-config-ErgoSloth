/*
 * Copyright (c) 2020 Pete Johanson
 *
 * SPDX-License-Identifier: MIT
 */

#include <physical_layouts.dtsi>
#include <dt-bindings/zmk/matrix_transform.h>
#include <dt-bindings/zmk/input_transform.h>
#include <dt-bindings/zmk/pointing.h>
#include <dt-bindings/zmk/bt.h>
#include <zephyr/dt-bindings/input/input-event-codes.h>
/* Reference: https://docs.zephyrproject.org/apidoc/latest/group__input__events.html */

#include "ErgoSloth-layouts.dtsi"

// Enable Analog Input
&adc {
	status = "okay";
};

// Inactivate I2C
&xiao_i2c { status = "disabled"; };

/ {

// encoders
    encoder_left: encoder_left {
        compatible = "alps,ec11";
        a-gpios = <&xiao_d 2 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        b-gpios = <&xiao_d 3 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        steps = <15>;
        status = "disabled";
    };

    encoder_right: encoder_right {
        compatible = "alps,ec11";
        a-gpios = <&xiao_d 2 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        b-gpios = <&xiao_d 3 (GPIO_ACTIVE_HIGH | GPIO_PULL_UP)>;
        steps = <15>;
        status = "disabled";
    };

    sensors: sensors {
        compatible = "zmk,keymap-sensors";
        sensors = <&encoder_left &encoder_right>;
        //triggers-per-rotation = <30>;  // From DataSheet
		triggers-per-rotation = <12>;
    };

// split options
    split_inputs {
        #address-cells = <1>;
        #size-cells = <0>;
/*
        glidepoint_left_split: glidepoint_left_split@1 {
            compatible = "zmk,input-split";
            reg = <1>;
        };
*/
        analog_joystick_left_split: analog_left_split@2 {
            compatible = "zmk,input-split";
            reg = <2>;
        };
    };

// trackball
    trackball_right_listener: trackball_right_listener {
        compatible = "zmk,input-listener";
        status = "disabled";
    };
/*
// touchpad
    glidepoint_left_listener: glidepoint_left_listener {
        compatible = "zmk,input-listener";
        status = "disabled";
        device = <&glidepoint_left_split>;
    };
*/
// joysticks
    analog_joystick_right_listener: analog_joystick_right_listener {
        status = "disabled";
        compatible = "zmk,input-listener";
    };

    analog_joystick_left_listener: analog_joystick_left_listener {
        status = "disabled";
        compatible = "zmk,input-listener";
        device = <&analog_joystick_left_split>;
    };

// keymap
    default_transform: keymap_transform_0 {
        compatible = "zmk,matrix-transform";
        columns = <14>;
        rows = <7>;

        //               | SW11 | SW16 | SW21 | SW26 |   | SW61 | SW66 | SW71 | SW76 |
        // | SW1  | SW6  | SW12 | SW17 | SW22 | SW27 |   | SW62 | SW67 | SW72 | SW77 | SW81 | SW86 |
        // | SW2  | SW7  | SW13 | SW18 | SW23 | SW28 |   | SW63 | SW68 | SW73 | SW78 | SW82 | SW87 |
        // | SW3  | SW8  | SW14 | SW19 | SW24 | SW29 |   | SW64 | SW69 | SW74 | SW79 | SW83 | SW88 |
        // | SW4  | SW9  | SW15 | SW20 | SW25 | SW30 |   | SW65 | SW70 | SW75 | SW80 | SW84 | SW89 |
        // | SW5  | SW10 | SW32 | SW33 | SW34 | (LAJS/   (RAJS) | SW95 | SW96 | SW97 | SW85 | SW90 |
        //                                      TouchPad)
        // 		                              | SW37 |   | SW92 |	    (TrackBall)
        // 							   | SW36 |					| SW93 |
        // | SW31 |				| SW35 |							   | SW94 |				| SW91 |
        //    (LeftRotaryEncoder)                                             (RightRotaryEncoder)
        //		  | SW38 |															 | SW98 |
        // | SW39 | SW42 | SW41 |											  | SW99 | SW102| SW101|
        // 		  | SW40 |															 | SW100|
        //                                             ||
        //                                           __||__
        //                                            \  /
        //                                             \/
		//
        // | SW1  | SW6  | SW11 | SW16 | SW21 | SW26 | SW32 |   | SW61 | SW66 | SW71 | SW76 | SW81 | SW86 | SW92 |
        // | SW2  | SW7  | SW12 | SW17 | SW22 | SW27 | SW33 |   | SW62 | SW67 | SW72 | SW77 | SW82 | SW87 | SW93 |
        // | SW3  | SW8  | SW13 | SW18 | SW23 | SW28 | SW34 |   | SW63 | SW68 | SW73 | SW78 | SW83 | SW88 | SW94 |
        // | SW4  | SW9  | SW14 | SW19 | SW24 | SW29 | SW35 |   | SW64 | SW69 | SW74 | SW79 | SW84 | SW89 | SW95 |
        // | SW5  | SW10 | SW15 | SW20 | SW25 | SW30 | SW36 |   | SW65 | SW70 | SW75 | SW80 | SW85 | SW90 | SW96 |
        // | SW38 | SW39 | SW40 | SW41 | SW42 | SW31 | SW37 |   | SW98 | SW99 | SW100| SW101| SW102| SW91 | SW97 |


        map = <
            RC(0,1) RC(1,0) RC(2,0) RC(3,0) RC(4,0) RC(5,0) RC(6,0)		RC(0,8) RC(1,7) RC(2,7) RC(3,7) RC(4,7) RC(5,7) RC(6,7)
            RC(0,2) RC(1,2) RC(2,1) RC(3,1) RC(4,1) RC(5,1) RC(6,1)     RC(0,9) RC(1,9) RC(2,8) RC(3,8) RC(4,8) RC(5,8) RC(6,8)
            RC(0,3) RC(1,3) RC(2,3) RC(3,2) RC(4,2) RC(5,2) RC(6,2)     RC(0,10) RC(1,10) RC(2,10) RC(3,9) RC(4,9) RC(5,9) RC(6,9)
            RC(0,4) RC(1,4) RC(2,4) RC(3,4) RC(4,3) RC(5,3) RC(6,3)     RC(0,11) RC(1,11) RC(2,11) RC(3,11) RC(4,10) RC(5,10) RC(6,10)
            RC(0,5) RC(1,5) RC(2,5) RC(3,5) RC(4,5) RC(5,4) RC(6,4)     RC(0,12) RC(1,12) RC(2,12) RC(3,12) RC(4,12) RC(5,11) RC(6,11)
			RC(0,6) RC(1,6) RC(2,6) RC(3,6) RC(4,6) RC(5,6) RC(6,5) 	RC(0,13) RC(1,13) RC(2,13) RC(3,13) RC(4,13) RC(5,13) RC(6,12)
        >;
    };

    kscan0: kscan {
        compatible = "zmk,kscan-gpio-charlieplex";
        wakeup-source;
        interrupt-gpios = <&xiao_d 4 (GPIO_ACTIVE_HIGH | GPIO_PULL_DOWN)>;
    };
};

// Use NFC pins as GPIOs
&uicr {
	nfct-pins-as-gpios;
};
    
&spi0 {
        status = "disabled";

        trackball_right: trackball_right@0 {
            status = "disabled";
            reg = <0>;
        };
};

&spi1 {
        status = "disabled";

        glidepoint_left: glidepoint_left@1 {
            status = "disabled";
            reg = <1>;
        };
};
